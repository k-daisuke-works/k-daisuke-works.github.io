# 実装確認 (Walkthrough): Multiple Gems Automation

## 実装した機能の詳細な説明
ユーザーの要望に基づき、複数のGemsに同じプロンプトを順番に入力して自動送信し、得られた成果物（スライドや画像などのHTMLファイル、およびプレーンテキスト）をローカルに一括保存するツール `gems_autosaver` を構築しました。

### フロントエンド部
- `public/index.html`, `public/style.css`, `public/script.js`
- 洗練されたガラスモーフィズム (Glassmorphism) デザイン。背景にはアニメーションするグラデーションの装飾を使用しています。
- **対象Gems URL入力欄**: 複数のGemini URLを改行区切りで入力します。
- **プロンプト入力欄**: 送信するテキスト・指示を入力します。
- **実行ボタン**: 各入力チェック後、Nodeサーバーに対してリクエストを行います。実行中はアニメーションスピナーとステータスメッセージを表示します。

### バックエンド APIサーバー部
- `server.js` (Expressサーバー)
- 起動するとポート3000番でアクセス可能なWebサーバーを立ち上げます。
- `POST /api/run` エンドポイントがフロントエンドから「複数のURLリスト」と「プロンプト」をJSON形式で受け取り、バックグラウンド処理を開始します。

### 自動化ロジック部 (Playwright)
- `automation.js`
1. **Persistent Context (ログイン状態の保持)**
   - ツール起動後 `chromium.launchPersistentContext()` を使い、ローカルの `userdata/` ディレクトリにブラウザ情報を記録します。これにより、一度ユーザーが手動でGoogleログインすれば、次回以降はパスワードや2段階認証をスキップできます（Cookieが残るため）。
2. **自動化ループ（並行実行へ強化）**
   - ユーザーから送信されたURLリストに対して、URLの数分だけ「一気に新しいタブ」を開き、全Gemsを並行で（同時に）処理します。（時間削減）
   - **特別入力ルール**: 最初のURL（1つ目のGem）に対してのみ、プロンプトテキストの中から「３．家族構成（構成と関係性）」のブロックのみを正規表現で自動的に切り出して送信します。2つ目以降のURLにはプロンプト全文を送信します。
   - `page.evaluate()` および Playwrightのキーボードエミュレーションを使って、Quillエディタ欄にプロンプトを確実に流し込みます。
   - 送信ボタン(`SEND`)またはエンターキーを押して送信を完了させます。
3. **完了待機と成果物の抽出スクレイピング**
   - 「生成を停止」ボタン等の非表示を監視後、さらに「レスポンス文字数が一定時間（約6秒以上）変動しなくなるまで」待機する2段構えシステムで、長文やアニメーションによる見逃しを防止します。
   - 抽出に際しては、強力なPlaywright Locatorを用いて、Shadow DOMなどの複雑なサイト構成を貫通してテキスト情報を特定します。
   - **テキスト全文**: レスポンス領域からテキストを抽出し、`downloads/`ディレクトリ配下に個別のログ（`.txt`）として出力します。
   - ※以前仕様として存在した「画像抽出」や「スライドコードの保存」機能については、ユーザーの要望により完全にスキップ・削除されました。
4. **すべてのタブの並行処理結果を `downloads/` に出力し完了。**

## 使用方法 (Usage)
1. ターミナルで `cd gems_autosaver` した状態で `node server.js` を実行します。
2. ブラウザで `http://localhost:3000/` にアクセスします。
3. 対象とする **Gems URL** と **実行したいプロンプト** を入力し、開始ボタンを押します。
4. Googleのログインがまだされていない場合、手元に自動起動したPlaywrightのブラウザが上がるので手動でログインを終えてください。ログイン後の次回起動からは自動で進行します。
5. 生成後は `/downloads` フォルダの中に保存されます。
