# 実装計画: 複数Gems用自動化ツール (Multiple Gems Automation)

## 1. 概要
ユーザーが一度入力したテキスト（プロンプト）を、指定した複数のGemini Gemsに自動で送信し、それぞれのGemからの成果物（画像ファイル、スライドなどを含むHTMLコードブロック、およびテキスト）をローカル環境へ自動ダウンロードするツールを構築します。

## 2. アーキテクチャ構成
本ツールはローカルで動作するNode.jsアプリケーションとして構築します。
1. **バックエンド (Node.js + Express + Playwright)**
   - **Express**: ブラウザ向けのフロントエンドを提供する軽量サーバー。APIエンドポイントでUIからの実行トリガーを受け取ります。
   - **Playwright**: 指定された複数のGems URLに対してブラウザを自動操作し、テキストの入力、送信、および生成結果のスクレイピングを行います。
   - 既存のGoogleアカウントのログイン状態を保持するため、Playwrightは永続的なコンテキスト（Local User Data Profile）を利用します。

2. **フロントエンド (HTML / Vanilla CSS / Vanilla JS)**
   - プレミアム感のあるガラスモーフィズム（Glassmorphism）デザインを採用。
   - プロンプト入力欄、および対象のGems URL（複数）を指定する入力欄を設けます。
   - 実行ボタンと進捗状況を表示するログ領域を実装します。

## 3. 主要機能
- **複数Gemsへの並行・自動送信**: Playwrightを用いて、入力されたURLリストの各Gemに「一斉に新しいタブでアクセス」し、プロンプトを並行して送信（Promise.all）します。処理時間を大幅に短縮します。
- **1つ目のGemに対する特別なプロンプト抽出（New!）**: 対象URLの最初（1つ目）のGemに対してのみ、プロンプトの中から「３．家族構成（構成と関係性）」のブロック部分だけを正規表現で自動的に切り出して送信します。2つ目以降はプロンプト全文がそのまま送信されます。
- **強力な待機と要素抽出ロジック**:
    - 通信完了を待機するだけでなく、レスポンスの文字数が一定時間変化しなくなる（物理的なDOMの安定）まで待機する2段構えシステムを実装しました。
    - Shadow DOM等に阻害されない、PlaywrightのLocatorを通じた確実なテキスト抽出ロジックを備えています。
- **ローカルへの保存**: 成果物（プレーンテキスト）を `downloads/` フォルダ配下に整理して保存します。※ スライド（HTML）や画像の保存機能はユーザーの要望によりスキップ・除外されました。

## 4. プロセスフロー
1. ユーザーはローカルで `npm start` を実行。サーバーが起動し、ブラウザでUIへアクセス（`http://localhost:3000`）。
2. プロンプトと、対象にしたいGemのURLを複数設定。
3. "実行" ボタンを押下。「自動化処理」がバックグラウンドで開始。
4. Playwrightのブラウザが立ち上がり、入力されたURLすべてのタブ一斉に開き、同時並行で処理を実行。
5. 作業完了後、ダウンロード済みの通知と保存先をフロントエンドに表示。
